<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ORGANISATION DES MODULES DE SOUTIEN</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- React and ReactDOM for the application logic -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for in-browser JSX/TSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
            @page {
                size: A3 landscape;
            }
        }
        .status-badge {
            transition: opacity 0.5s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">

    // --- FROM constants.ts ---
    const MODULE_THEMES = [
        { name: 'PARCOURSUP', color: 'bg-red-500' },
        { name: 'ENTREPREUNARIAT', color: 'bg-violet-500' },
        { name: 'AVENIR PRO', color: 'bg-blue-500' },
        { name: 'NORIA IRL', color: 'bg-lime-500' },
        { name: 'INTERVENANT EXT', color: 'bg-green-500' },
        { name: 'OUVERTURE SUR LE MONDE', color: 'bg-cyan-500' },
        { name: 'CONNAISSANCE DE SOI', color: 'bg-amber-500' },
        { name: 'VIE ÉTUDIANTE / AUTO', color: 'bg-sky-500' },
        { name: 'VISITE EXT', color: 'bg-pink-500' },
        { name: 'MOBILITÉ / PERSÉVÉRANCE', color: 'bg-orange-500' },
        { name: 'AUTRES / DIVERS ...', color: 'bg-purple-500' },
    ];
    const SHARED_PASSWORD = 'soutien';
    const CALENDAR_STRUCTURE = [
        { month: 'Septembre', weeks: [36, 37, 38, 39] }, { month: 'Octobre', weeks: [40, 41, 42, 43, 44] },
        { month: 'Novembre', weeks: [45, 46, 47, 48] }, { month: 'Décembre', weeks: [49, 50, 51, 52] },
        { month: 'Janvier', weeks: [1, 2, 3, 4, 5] }, { month: 'Février', weeks: [6, 7, 8, 9] },
        { month: 'Mars', weeks: [10, 11, 12, 13] }, { month: 'Avril', weeks: [14, 15, 16, 17, 18] },
        { month: 'Mai', weeks: [19, 20, 21, 22] }, { month: 'Juin', weeks: [23, 24, 25, 26] },
        { month: 'Juillet', weeks: [27, 28, 29, 30, 31] }, { month: 'Août', weeks: [32, 33, 34, 35] },
    ];
    const initialCalendarState = CALENDAR_STRUCTURE.reduce((acc, month) => {
        month.weeks.forEach(week => { acc[`${month.month}-${week}`] = []; });
        return { ...acc, palette: [] };
    }, {});

    // --- Custom Hooks ---
    const useDebounce = (value, delay) => {
        const [debouncedValue, setDebouncedValue] = React.useState(value);
        React.useEffect(() => {
            const handler = setTimeout(() => { setDebouncedValue(value); }, delay);
            return () => { clearTimeout(handler); };
        }, [value, delay]);
        return debouncedValue;
    };

    // --- FROM components/Module.tsx ---
    const Module = ({ module, sourceCellId, isSelected, onSelect }) => {
        const handleDragStart = (e) => {
            // Baserow row ID is used as the canonical module ID
            e.dataTransfer.setData('moduleId', module.id);
            e.dataTransfer.setData('sourceCellId', sourceCellId);
        };
        const handleClick = (e) => {
            e.stopPropagation();
            onSelect(isSelected ? null : module.id, sourceCellId);
        };
        return (
            <div
                draggable
                onDragStart={handleDragStart}
                onClick={handleClick}
                className={`p-2.5 rounded-md text-white cursor-grab shadow-md flex flex-col gap-1 ${module.color} ${isSelected ? 'ring-2 ring-offset-2 ring-offset-gray-800 ring-sky-400' : ''}`}
            >
                <strong className="block text-sm truncate font-bold">{module.name}</strong>
                {module.description && <p className="text-xs text-white/80 font-normal truncate">{module.description}</p>}
                <div className="text-xs text-white/90 font-medium mt-1 space-y-1">
                    {module.speakers && (
                        <div className="flex items-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" /></svg>
                            <span className="truncate">{module.speakers}</span>
                        </div>
                    )}
                    {module.maxStudents && (
                        <div className="flex items-center gap-1.5">
                             <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                            <span className="truncate">{module.maxStudents} élèves max</span>
                        </div>
                    )}
                </div>
            </div>
        );
    };
    
    // --- FROM components/CalendarCell.tsx ---
    const SPECIAL_WEEKS = {
        10: { text: 'PFMP', color: '#c7f0a6', textColor: '#1f2937' }, 11: { text: 'PFMP', color: '#c7f0a6', textColor: '#1f2937' },
        12: { text: 'PFMP', color: '#c7f0a6', textColor: '#1f2937' }, 40: { text: 'PFMP', color: '#c7f0a6', textColor: '#1f2937' },
        41: { text: 'PFMP', color: '#c7f0a6', textColor: '#1f2937' }, 42: { text: 'PFMP', color: '#c7f0a6', textColor: '#1f2937' },
        43: { text: 'Vacances de la Toussaint', color: '#c7c511', textColor: '#1f2937' }, 44: { text: 'Vacances de la Toussaint', color: '#c7c511', textColor: '#1f2937' },
        52: { text: 'Vacances de Noël', color: '#c7c511', textColor: '#1f2937' }, 1: { text: 'Vacances de Noël', color: '#c7c511', textColor: '#1f2937' },
        8: { text: "Vacances d'hiver", color: '#c7c511', textColor: '#1f2937' }, 9: { text: "Vacances d'hiver", color: '#c7c511', textColor: '#1f2937' },
        16: { text: 'Vacances de printemps', color: '#c7c511', textColor: '#1f2937' }, 17: { text: 'Vacances de printemps', color: '#c7c511', textColor: '#1f2937' },
        28: { text: "Vacances d'été", color: '#c7c511', textColor: '#1f2937' }, 29: { text: "Vacances d'été", color: '#c7c511', textColor: '#1f2937' },
        30: { text: "Vacances d'été", color: '#c7c511', textColor: '#1f2937' }, 31: { text: "Vacances d'été", color: '#c7c511', textColor: '#1f2937' },
        32: { text: "Vacances d'été", color: '#c7c511', textColor: '#1f2937' }, 33: { text: "Vacances d'été", color: '#c7c511', textColor: '#1f2937' },
        34: { text: "Vacances d'été", color: '#c7c511', textColor: '#1f2937' }, 35: { text: "Vacances d'été", color: '#c7c511', textColor: '#1f2937' },
    };
    const CalendarCell = ({ cellId, weekNumber, moduleIds, modules, onDrop, selectedModuleId, onSelectModule }) => {
        const [isDragOver, setIsDragOver] = React.useState(false);
        const specialWeekInfo = SPECIAL_WEEKS[weekNumber];
        const handleDragOver = (e) => { if (specialWeekInfo) return; e.preventDefault(); setIsDragOver(true); };
        const handleDragLeave = (e) => { if (specialWeekInfo) return; e.preventDefault(); setIsDragOver(false); };
        const handleDrop = (e) => {
            if (specialWeekInfo) return; e.preventDefault(); setIsDragOver(false);
            const moduleId = e.dataTransfer.getData('moduleId'); const sourceCellId = e.dataTransfer.getData('sourceCellId');
            onDrop(moduleId, sourceCellId, cellId);
        };
        if (specialWeekInfo) {
            return (
                <div className="p-2 rounded-md min-h-[80px] flex-grow flex items-center justify-center text-center" style={{ backgroundColor: specialWeekInfo.color }}>
                    <span className="text-sm font-bold" style={{ color: specialWeekInfo.textColor || '#1f2937' }}>{specialWeekInfo.text}</span>
                </div>
            );
        }
        return (
            <div onDrop={handleDrop} onDragOver={handleDragOver} onDragLeave={handleDragLeave} className={`p-2 rounded-md transition-colors duration-300 min-h-[80px] flex-grow ${isDragOver ? 'bg-sky-900/50' : 'bg-gray-700/50'}`}>
                <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-gray-400">S{weekNumber}</span></div>
                <div className="flex flex-col gap-1">
                    {moduleIds.map((id, index) => {
                        const moduleData = modules[id];
                        // Ensure module data exists before rendering
                        if (!moduleData) {
                            console.warn(`Module with ID ${id} not found.`);
                            return null;
                        }
                        return <Module key={`${id}-${index}`} module={moduleData} sourceCellId={cellId} isSelected={selectedModuleId === id} onSelect={(moduleId) => onSelectModule(moduleId, cellId)} />
                    })}
                </div>
            </div>
        );
    };
    
    // --- FROM components/Calendar.tsx ---
    const COLUMN_LAYOUT = [ ['Septembre', 'Janvier', 'Mai'], ['Octobre', 'Février', 'Juin'], ['Novembre', 'Mars', 'Juillet'], ['Décembre', 'Avril', 'Août'], ];
    const CALENDAR_DATA_BY_NAME = CALENDAR_STRUCTURE.reduce((acc, monthData) => { acc[monthData.month] = monthData; return acc; }, {});
    const Calendar = ({ calendarState, modules, onDrop, selectedModuleId, onSelectModule }) => {
        return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {COLUMN_LAYOUT.map((column, colIndex) => (
                    <div key={`col-${colIndex}`} className="flex flex-col gap-4">
                        {column.map(monthName => {
                            const monthData = CALENDAR_DATA_BY_NAME[monthName]; if (!monthData) return null;
                            const { month, weeks } = monthData;
                            const weekCells = weeks.map(week => {
                                const cellId = `${month}-${week}`;
                                return <CalendarCell key={cellId} cellId={cellId} weekNumber={week} moduleIds={calendarState[cellId] || []} modules={modules} onDrop={onDrop} selectedModuleId={selectedModuleId} onSelectModule={onSelectModule} />;
                            });
                            return (
                                <div key={month} className="bg-gray-800 p-3 rounded-lg flex flex-col gap-2">
                                    <h2 className="text-xl font-bold text-center text-sky-400 mb-2">{month}</h2>
                                    {weekCells}
                                </div>
                            );
                        })}
                    </div>
                ))}
            </div>
        );
    };

    // --- FROM components/CreateModuleForm.tsx ---
    const CreateModuleForm = ({ onCreate }) => {
        const [name, setName] = React.useState(''); const [description, setDescription] = React.useState('');
        const [speakers, setSpeakers] = React.useState(''); const [maxStudents, setMaxStudents] = React.useState('');
        const [selectedColor, setSelectedColor] = React.useState(MODULE_THEMES[0].color);
        const handleSubmit = (e) => {
            e.preventDefault();
            if (name.trim()) {
                onCreate({ name, description, speakers, maxStudents: maxStudents || null, color: selectedColor });
                setName(''); setDescription(''); setSpeakers(''); setMaxStudents('');
            }
        };
        const inputClasses = "w-full px-3 py-2 text-white bg-gray-800 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500";
        const labelClasses = "block text-sm font-medium text-gray-300 mb-1";
        return (
            <div className="p-4 bg-gray-700/50 rounded-lg">
                <h2 className="text-lg font-semibold mb-3">Créer un module</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div><label htmlFor="module-name" className={labelClasses}>NOM DU MODULE :</label><input id="module-name" type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="Ex: Introduction à React" className={inputClasses} required /></div>
                    <div><label htmlFor="module-desc" className={labelClasses}>Description sommaire :</label><textarea id="module-desc" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="Contenu du cours..." rows={2} className={inputClasses} /></div>
                    <div><label htmlFor="module-speakers" className={labelClasses}>Intervenant(s) :</label><input id="module-speakers" type="text" value={speakers} onChange={(e) => setSpeakers(e.target.value)} placeholder="Ex: Jean Dupont" className={inputClasses} /></div>
                    <div><label htmlFor="module-students" className={labelClasses}>Nombre élèves max :</label><input id="module-students" type="number" value={maxStudents} onChange={(e) => setMaxStudents(e.target.value)} placeholder="Ex: 25" className={inputClasses} /></div>
                    <div>
                        <label className={labelClasses}>Thématique :</label>
                        <div className="grid grid-cols-2 gap-2 pt-1">
                            {MODULE_THEMES.map(theme => (
                                <button
                                    key={theme.name}
                                    type="button"
                                    onClick={() => setSelectedColor(theme.color)}
                                    className={`w-full px-2 py-2.5 text-xs font-bold text-white rounded-md transition-all duration-150 text-center ${theme.color} ${selectedColor === theme.color ? 'ring-2 ring-offset-2 ring-offset-gray-800 ring-white scale-105' : 'hover:scale-105 hover:opacity-90'}`}
                                >
                                    {theme.name}
                                </button>
                            ))}
                        </div>
                    </div>
                    <button type="submit" className="w-full px-4 py-2 font-bold text-white bg-sky-600 rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-sky-500 transition-colors duration-200">Générer le Module</button>
                </form>
            </div>
        );
    };

    // --- FROM components/LoginScreen.tsx ---
    const LoginScreen = ({ onLogin }) => {
        const [password, setPassword] = React.useState('');
        const handleSubmit = (e) => { e.preventDefault(); onLogin(password); };
        return (
            <div className="flex items-center justify-center h-screen bg-gray-900 text-white">
                <div className="w-full max-w-sm p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg">
                    <h1 className="text-3xl font-bold text-center text-sky-400">Accès Enseignant</h1>
                    <p className="text-center text-gray-400">Veuillez entrer l'identifiant commun pour accéder au planning.</p>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div><label htmlFor="password-input" className="sr-only">Identifiant</label><input id="password-input" type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Identifiant commun" className="w-full px-4 py-2 text-white bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500" /></div>
                        <button type="submit" className="w-full px-4 py-2 font-bold text-white bg-sky-600 rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-sky-500 transition-colors duration-200">Se connecter</button>
                    </form>
                </div>
            </div>
        );
    };
    
    // --- FROM components/ModulePalette.tsx ---
    const ModulePalette = ({ cellId, moduleIds, modules, onDrop, selectedModuleId, onSelectModule }) => {
        const [isDragOver, setIsDragOver] = React.useState(false);
        const handleDragOver = (e) => { e.preventDefault(); setIsDragOver(true); };
        const handleDragLeave = (e) => { e.preventDefault(); setIsDragOver(false); };
        const handleDrop = (e) => {
            e.preventDefault(); setIsDragOver(false);
            const moduleId = e.dataTransfer.getData('moduleId'); const sourceCellId = e.dataTransfer.getData('sourceCellId');
            onDrop(moduleId, sourceCellId, cellId);
        };
        return (
            <div className="flex-1 flex flex-col">
                <h2 className="text-lg font-semibold mb-3">Modules disponibles</h2>
                <div onDrop={handleDrop} onDragOver={handleDragOver} onDragLeave={handleDragLeave} className={`flex-1 p-3 bg-gray-900/50 rounded-lg border-2 border-dashed ${isDragOver ? 'border-sky-500' : 'border-gray-600'} transition-colors duration-200`}>
                    <div className="flex flex-wrap gap-2">
                        {moduleIds.map(id => (
                            <Module key={id} module={modules[id]} sourceCellId={cellId} isSelected={selectedModuleId === id} onSelect={(moduleId) => onSelectModule(moduleId, cellId)} />
                        ))}
                         {moduleIds.length === 0 && (<p className="text-gray-400 text-sm w-full text-center py-4">Créez un module pour commencer.</p>)}
                    </div>
                </div>
            </div>
        );
    };

    // --- FROM components/PrintButton.tsx ---
    const DownloadButton = () => {
        const [isLoading, setIsLoading] = React.useState(false);
        const getFileName = () => `planning-soutien-${new Date().toISOString().slice(0, 10)}`;
        const captureCanvas = async () => {
            const elementToCapture = document.querySelector('.printable-area');
            if (!elementToCapture) { console.error('Printable area not found'); return null; }
            const clone = elementToCapture.cloneNode(true);
            const printContainer = document.createElement('div');
            printContainer.style.position = 'absolute'; printContainer.style.left = '-9999px'; printContainer.style.top = '0px';
            printContainer.style.width = '1920px'; clone.style.margin = '0';
            printContainer.appendChild(clone); document.body.appendChild(printContainer);
            let canvas = null;
            try {
                await new Promise(resolve => setTimeout(resolve, 300));
                const captureWidth = 1920; const captureHeight = clone.scrollHeight;
                canvas = await html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#111827', width: captureWidth, height: captureHeight, windowWidth: captureWidth, windowHeight: captureHeight });
            } catch (error) { console.error("Error during html2canvas capture:", error); } 
            finally { document.body.removeChild(printContainer); }
            return canvas;
        };
        const handleDownloadPDF = async () => {
            setIsLoading(true);
            try {
                const canvas = await captureCanvas();
                if (canvas) {
                    const imgData = canvas.toDataURL('image/png'); const imgWidth = canvas.width; const imgHeight = canvas.height;
                    const pdfWidth = 1190.55; const pdfHeight = (imgHeight * pdfWidth) / imgWidth;
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a3' });
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`${getFileName()}.pdf`);
                }
            } catch (error) { console.error("Error generating PDF:", error); alert("Une erreur est survenue lors de la génération du PDF."); } 
            finally { setIsLoading(false); }
        };
        return (
            <div className="no-print">
                <button onClick={handleDownloadPDF} disabled={isLoading} className="inline-flex items-center justify-center rounded-md shadow-sm px-4 py-2 bg-indigo-600 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-indigo-500 transition-colors duration-200 disabled:bg-indigo-800 disabled:cursor-not-allowed">
                    {isLoading ? 'Génération en cours...' : 'Télécharger (PDF A3)'}
                    {!isLoading && (<svg xmlns="http://www.w3.org/2000/svg" className="ml-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" /></svg>)}
                </button>
            </div>
        );
    };

    // --- Hardcoded Baserow credentials ---
    // ACTION REQUISE: Remplacez les valeurs ci-dessous par vos propres informations Baserow.
    // L'application utilise maintenant DEUX tables séparées.
    const HARCODED_BASEROW_CREDENTIALS = {
        apiUrl: 'https://api.baserow.io', 
        token: '7nOTtTnebOvuTmO2tL7cjmMZTfgKC2vn',              // ex: 'fLyA...'
        modulesTableId: '724013', // ex: 12345
        calendarStateTableId: '724014', // ex: 67890
    };
    
    // --- Component to show if credentials are not set ---
    const ConfigurationNeededScreen = () => (
        <div className="flex items-center justify-center h-screen bg-gray-900 text-white">
            <div className="w-full max-w-lg p-8 text-center bg-gray-800 rounded-lg shadow-lg">
                <h1 className="text-3xl font-bold text-red-500">Action Requise</h1>
                <p className="mt-4 text-gray-300">
                    Les informations de connexion à Baserow doivent être intégrées directement dans le code source.
                </p>
                <p className="mt-2 text-gray-400">
                    Veuillez éditer le fichier <code>index.html</code>, trouver la constante <code>HARCODED_BASEROW_CREDENTIALS</code>, et remplacer les valeurs d'exemple par vos propres informations (Jeton API et les deux IDs de table).
                </p>
            </div>
        </div>
    );

    // --- Component for Baserow connection errors ---
    const BaserowErrorScreen = ({ error, onRetry }) => (
        <div className="flex items-center justify-center h-screen bg-gray-900 text-white">
            <div className="w-full max-w-2xl p-8 bg-gray-800 rounded-lg shadow-lg">
                <div className="text-center">
                    <h1 className="text-3xl font-bold text-red-500">{error.title || "Erreur de Configuration"}</h1>
                    <p className="mt-4 text-lg text-gray-300">
                        {error.message || "Impossible de charger les données depuis Baserow."}
                    </p>
                    {error.details && (
                         <pre className="mt-4 text-left bg-gray-900 p-4 rounded-md text-sm text-red-300 overflow-x-auto">
                            <code>Détail technique : {error.details}</code>
                        </pre>
                    )}
                </div>
                <div className="mt-6 text-left text-gray-400 space-y-2">
                    <p className="font-bold text-gray-200">Liste de vérification :</p>
                    <ul className="list-disc list-inside space-y-1">
                        <li>Le <strong>Jeton d'API (token)</strong> est-il correct et a-t-il les permissions de lecture/écriture ?</li>
                        <li>L'ID de la table <strong>Modules</strong> (<code>modulesTableId</code>) est-il correct ?</li>
                        <li>L'ID de la table <strong>CalendarState</strong> (<code>calendarStateTableId</code>) est-il correct ?</li>
                        <li>Vos tables et leurs champs correspondent-ils bien à la structure attendue (par ex. un champ `moduleIds` dans `CalendarState`) ?</li>
                    </ul>
                </div>
                 <button onClick={onRetry} className="mt-8 w-full px-4 py-2 font-bold text-white bg-sky-600 rounded-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-sky-500 transition-colors duration-200">
                    Réessayer la connexion
                </button>
            </div>
        </div>
    );
    
    // --- Baserow API Helpers ---
    const baserowApi = {
        async listRows(tableId, token) {
            const url = `${HARCODED_BASEROW_CREDENTIALS.apiUrl}/api/database/rows/table/${tableId}/?user_field_names=true&size=200`;
            const response = await fetch(url, { headers: { 'Authorization': `Token ${token}` } });
            if (!response.ok) {
                const error = new Error(`HTTP error listing rows from table ${tableId}`);
                error.response = response;
                throw error;
            }
            const { results } = await response.json();
            return results;
        },
        async createRow(tableId, token, data) {
            const url = `${HARCODED_BASEROW_CREDENTIALS.apiUrl}/api/database/rows/table/${tableId}/?user_field_names=true`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            if (!response.ok) throw new Error('Failed to create row');
            return await response.json();
        },
        async updateRow(tableId, token, rowId, data) {
            const url = `${HARCODED_BASEROW_CREDENTIALS.apiUrl}/api/database/rows/table/${tableId}/${rowId}/?user_field_names=true`;
            await fetch(url, {
                method: 'PATCH',
                headers: { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
        },
        async deleteRow(tableId, token, rowId) {
            const url = `${HARCODED_BASEROW_CREDENTIALS.apiUrl}/api/database/rows/table/${tableId}/${rowId}/`;
            await fetch(url, { method: 'DELETE', headers: { 'Authorization': `Token ${token}` } });
        }
    };


    // --- FROM App.tsx ---
    const App = () => {
        const [isLoggedIn, setIsLoggedIn] = React.useState(false);
        const [baserowCreds] = React.useState(HARCODED_BASEROW_CREDENTIALS);
        const [syncStatus, setSyncStatus] = React.useState('idle');
        const [errorInfo, setErrorInfo] = React.useState(null);
        
        const [modules, setModules] = React.useState({});
        const [calendarState, setCalendarState] = React.useState(initialCalendarState);
        const [calendarRowMap, setCalendarRowMap] = React.useState({});

        const [selectedModuleInfo, setSelectedModuleInfo] = React.useState(null);
        const debouncedCalendarState = useDebounce(calendarState, 2000);
        
        const isConfigured = baserowCreds.token && !baserowCreds.token.includes('ICI') && baserowCreds.modulesTableId && !baserowCreds.modulesTableId.includes('ICI');

        const fetchData = React.useCallback(async () => {
            if (!isConfigured) return;
            setSyncStatus('loading');
            setErrorInfo(null);
            try {
                const [modulesData, calendarData] = await Promise.all([
                    baserowApi.listRows(baserowCreds.modulesTableId, baserowCreds.token),
                    baserowApi.listRows(baserowCreds.calendarStateTableId, baserowCreds.token)
                ]);

                // Process modules
                const newModules = modulesData.reduce((acc, row) => {
                    acc[row.id] = { ...row, maxStudents: row.maxStudents || '' }; // Use Baserow's row ID as the unique module ID
                    return acc;
                }, {});
                setModules(newModules);
                
                // Process calendar state
                const newCalendarState = { ...initialCalendarState };
                const newCalendarRowMap = {};
                calendarData.forEach(row => {
                    if (row.cellId) {
                         // moduleIds are stored as text, potentially null
                        newCalendarState[row.cellId] = (row.moduleIds || '').split(',').filter(Boolean).map(id => parseInt(id, 10));
                        newCalendarRowMap[row.cellId] = row.id;
                    }
                });
                
                // Set the palette with all loaded modules that are not yet placed
                const placedModuleIds = new Set(Object.values(newCalendarState).flat());
                newCalendarState.palette = Object.keys(newModules).map(id => parseInt(id, 10)).filter(id => !placedModuleIds.has(id));
                
                setCalendarState(newCalendarState);
                setCalendarRowMap(newCalendarRowMap);

                setSyncStatus('synced');
            } catch (error) {
                console.error("Failed to fetch from Baserow:", error);
                setSyncStatus('error');
                 let detailedError = { title: "Erreur de Connexion à Baserow", message: "Une erreur inattendue est survenue.", details: error.message };
                 if (error.response) {
                    const status = error.response.status;
                    detailedError.details = `Status HTTP: ${status}.`;
                    if (status === 401) detailedError.message = "Le jeton d'API (token) est invalide ou ne dispose pas des permissions nécessaires.";
                    else if (status === 404) detailedError.message = "Une des tables est introuvable. Veuillez vérifier 'modulesTableId' et 'calendarStateTableId'.";
                }
                setErrorInfo(detailedError);
            }
        }, [isConfigured, baserowCreds]);

        React.useEffect(() => {
            if (isConfigured && isLoggedIn) {
                fetchData();
            }
        }, [isConfigured, isLoggedIn, fetchData]);
        
        const isInitialMount = React.useRef(true);
        React.useEffect(() => {
            if (isInitialMount.current) { isInitialMount.current = false; return; }
            if (syncStatus === 'loading' || !isConfigured || errorInfo) return;
            
            const saveCalendarState = async () => {
                setSyncStatus('saving');
                try {
                    const changedCells = Object.keys(debouncedCalendarState).filter(cellId => cellId !== 'palette');
                    
                    for (const cellId of changedCells) {
                        const moduleIdsString = debouncedCalendarState[cellId].join(',');
                        const rowId = calendarRowMap[cellId];
                        if (rowId) { // Row exists, update it
                            await baserowApi.updateRow(baserowCreds.calendarStateTableId, baserowCreds.token, rowId, { moduleIds: moduleIdsString });
                        } else if (debouncedCalendarState[cellId].length > 0) { // New row with content, create it
                            const newRow = await baserowApi.createRow(baserowCreds.calendarStateTableId, baserowCreds.token, { cellId: cellId, moduleIds: moduleIdsString });
                            setCalendarRowMap(prev => ({...prev, [cellId]: newRow.id}));
                        }
                    }
                    setSyncStatus('synced');
                } catch (error) { console.error("Failed to save to Baserow:", error); setSyncStatus('error'); }
            };

            saveCalendarState();
        }, [debouncedCalendarState, isConfigured, errorInfo, baserowCreds]);

        React.useEffect(() => { let timer; if (syncStatus === 'synced') timer = setTimeout(() => setSyncStatus('idle'), 2000); return () => clearTimeout(timer); }, [syncStatus]);

        const handleLogin = (password) => { if (password === SHARED_PASSWORD) { setIsLoggedIn(true); } else { alert('Identifiant incorrect.'); } };
        const handleLogout = () => { setIsLoggedIn(false); };

        const handleCreateModule = React.useCallback(async (moduleData) => {
            setSyncStatus('saving');
            try {
                const newModuleRow = await baserowApi.createRow(baserowCreds.modulesTableId, baserowCreds.token, moduleData);
                setModules(prev => ({ ...prev, [newModuleRow.id]: { ...newModuleRow, maxStudents: newModuleRow.maxStudents || '' } }));
                setCalendarState(prev => ({...prev, palette: [...prev.palette, newModuleRow.id]}));
                setSyncStatus('synced');
            } catch (error) { console.error("Failed to create module:", error); setSyncStatus('error'); }
        }, [baserowCreds]);

        const handleDrop = React.useCallback((moduleIdStr, sourceCellId, targetCellId) => {
            if (!moduleIdStr || !sourceCellId || !targetCellId || sourceCellId === targetCellId) return;
            const moduleId = parseInt(moduleIdStr, 10);
            setCalendarState(prev => {
                const newCalendarState = { ...prev };
                
                const sourceModules = [...(newCalendarState[sourceCellId] || [])];
                const moduleIndex = sourceModules.indexOf(moduleId);
                if (moduleIndex > -1) sourceModules.splice(moduleIndex, 1);
                newCalendarState[sourceCellId] = sourceModules;
                
                const targetModules = [...(newCalendarState[targetCellId] || [])];
                if (!targetModules.includes(moduleId)) targetModules.push(moduleId);
                newCalendarState[targetCellId] = targetModules;
                
                return newCalendarState;
            });
            setSelectedModuleInfo(null);
        }, []);
        
        const handleSelectModule = (moduleId, cellId) => setSelectedModuleInfo(moduleId && cellId ? { id: moduleId, cellId } : null);
        
        const handleDeleteModule = React.useCallback(async () => {
            if (!selectedModuleInfo) return;
            const { id: moduleId, cellId } = selectedModuleInfo;
            if (cellId === 'palette') {
                if (window.confirm("Supprimer ce module de la palette le retirera de la base de données et de tout le calendrier. Continuer ?")) {
                    setSyncStatus('saving');
                    try {
                        await baserowApi.deleteRow(baserowCreds.modulesTableId, baserowCreds.token, moduleId);
                        
                        setModules(prev => { const newModules = { ...prev }; delete newModules[moduleId]; return newModules; });
                        setCalendarState(prev => {
                            const newCalendarState = { ...prev };
                            for (const key in newCalendarState) { newCalendarState[key] = newCalendarState[key].filter(id => id !== moduleId); }
                            return newCalendarState;
                        });
                        setSyncStatus('synced');
                    } catch (error) { console.error("Failed to delete module:", error); setSyncStatus('error'); }
                }
            } else {
                 setCalendarState(prev => {
                    const newCalendarState = { ...prev };
                    const cellModules = [...(newCalendarState[cellId] || [])];
                    const indexToRemove = cellModules.indexOf(moduleId);
                    if (indexToRemove > -1) cellModules.splice(indexToRemove, 1);
                    newCalendarState[cellId] = cellModules;
                    // Also move it back to the palette if it's not there
                    if (!newCalendarState.palette.includes(moduleId)) {
                        newCalendarState.palette = [...newCalendarState.palette, moduleId];
                    }
                    return newCalendarState;
                });
            }
            setSelectedModuleInfo(null);
        }, [selectedModuleInfo, baserowCreds]);
        
        const handleDuplicateModule = React.useCallback(() => {
            if (!selectedModuleInfo || selectedModuleInfo.cellId === 'palette') return;
            const { id: moduleId, cellId } = selectedModuleInfo;
            setCalendarState(prev => {
                const newCalendarState = { ...prev };
                const cellModules = [...(newCalendarState[cellId] || [])];
                const indexToDuplicate = cellModules.lastIndexOf(moduleId);
                if (indexToDuplicate > -1) { cellModules.splice(indexToDuplicate + 1, 0, moduleId); }
                newCalendarState[cellId] = cellModules;
                return newCalendarState;
            });
            setSelectedModuleInfo(null);
        }, [selectedModuleInfo]);

        React.useEffect(() => {
            const handleKeyDown = (event) => {
                const target = event.target;
                if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') return;
                if (event.key === 'Delete' || event.key === 'Backspace') { if(selectedModuleInfo) handleDeleteModule(); }
                else if ((event.ctrlKey || event.metaKey) && (event.key === 'd' || event.key === 'D')) {
                    if (selectedModuleInfo) { event.preventDefault(); handleDuplicateModule(); }
                }
            };
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
        }, [selectedModuleInfo, handleDeleteModule, handleDuplicateModule]);

        const StatusIndicator = () => {
            const statusMap = {
                loading: { text: "Chargement...", color: "bg-blue-500" },
                saving: { text: "Sauvegarde...", color: "bg-yellow-500 animate-pulse" },
                synced: { text: "Synchronisé ✔", color: "bg-green-500" },
                error: { text: "Erreur ❌", color: "bg-red-500" },
            };
            const currentStatus = statusMap[syncStatus];
            if (!currentStatus || syncStatus === 'idle') return null;
            return (
                <div className={`status-badge fixed bottom-4 right-4 px-3 py-1.5 text-sm font-medium text-white rounded-full shadow-lg ${currentStatus.color} ${syncStatus === 'idle' ? 'opacity-0' : 'opacity-100'}`}>
                    {currentStatus.text}
                </div>
            );
        };

        if (!isLoggedIn) return <LoginScreen onLogin={handleLogin} />;
        if (!isConfigured) return <ConfigurationNeededScreen />;
        if (errorInfo) return <BaserowErrorScreen error={errorInfo} onRetry={fetchData} />;
        
        return (
            <div id="app-container" className="flex flex-col md:flex-row h-screen bg-gray-900 text-white font-sans">
                <StatusIndicator />
                <aside className="w-full md:w-80 p-4 bg-gray-800 shadow-lg flex flex-col gap-6 overflow-y-auto no-print">
                    <div className="flex items-center justify-between">
                      <h1 className="text-2xl font-bold text-sky-400">Panneau de Contrôle</h1>
                      <button onClick={handleLogout} title="Déconnexion" className="text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                      </button>
                    </div>
                    <CreateModuleForm onCreate={handleCreateModule} />
                    <ModulePalette cellId="palette" moduleIds={calendarState['palette'] || []} modules={modules} onDrop={handleDrop} selectedModuleId={selectedModuleInfo?.id ?? null} onSelectModule={handleSelectModule} />
                </aside>
                <main className="flex-1 p-4 overflow-auto printable-area">
                    <div className="flex justify-between items-start mb-4">
                        <h1 className="text-xl font-bold flex-grow pr-4">ORGANISATION DES MODULES DU SOUTIEN AU PARCOURS - TERMINALES PROFESSIONNELLES - 2025/2026</h1>
                        <DownloadButton />
                    </div>
                    <Calendar calendarState={calendarState} modules={modules} onDrop={handleDrop} selectedModuleId={selectedModuleInfo?.id ?? null} onSelectModule={handleSelectModule} />
                </main>
            </div>
        );
    };

    // --- FROM index.tsx ---
    const rootElement = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElement);
    root.render(
      <React.StrictMode>
        <App />
      </React.StrictMode>
    );

    </script>
</body>
</html>
